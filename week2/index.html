<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>iTunes Music Fetch — Demo</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    body{font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:0;padding:24px}
    nav img{height:28px}
    header{margin:12px 0 20px}
    h1{margin:.2rem 0 0}
    .subtitle{color:#666;margin:.2rem 0 1rem}
    button{padding:10px 14px;border-radius:10px;border:1px solid #ccc;background:#111;color:#fff;cursor:pointer}
    button:hover{filter:brightness(1.1)}
    #main-content{margin-top:16px}
    .card{display:grid;grid-template-columns:180px 1fr;gap:16px;align-items:start;max-width:860px}
    .cover{width:180px;height:180px;border-radius:12px;object-fit:cover;border:1px solid #ddd}
    audio{width:100%;margin-top:8px}
    .muted{opacity:.7}
  </style>
</head>

<body>
  <nav class="topbar">
    <img src="ITunes_logo.svg.png" alt="iTunes logo"/>
  </nav>

  <header>
    <h1>Pull a Random Sound!</h1>
    <p class="subtitle">Get one from iTunes Search API — fresh every click.</p>
    <button id="fetch-button" aria-label="Fetch a random track">Click here</button>
  </header>

  <main id="main-content"></main>

<script>
const mainContent   = document.getElementById('main-content');
const triggerButton = document.getElementById('fetch-button');

// 常见关键词，确保大概率有预览
const SEEDS = [
  "jazz","lofi","ambient","piano","guitar","string quartet","electronic",
  "hip hop","rock","pop","RnB","synth","orchestra","folk","blues","house",
  "soundtrack","game","film","chill","beats","dub","trance","metal","acoustic"
];

triggerButton.addEventListener('click', () => {
  mainContent.textContent = 'Loading...';
  fetchRandomTrackWithRetry(0);
});

// 最多重试 6 次，直到拿到带 previewUrl 的结果
async function fetchRandomTrackWithRetry(attempt){
  if (attempt >= 6){
    mainContent.textContent = '加载失败：Tried 6 times, no previewable track.';
    return;
  }

  const term = SEEDS[Math.floor(Math.random()*SEEDS.length)];
  try{
    const url = new URL('https://itunes.apple.com/search');
    url.searchParams.set('term', term);
    url.searchParams.set('media','music');
    url.searchParams.set('entity','musicTrack');
    url.searchParams.set('limit','50');
    url.searchParams.set('country','US');

    const res = await fetch(url.toString());
    if(!res.ok){
      const t = await res.text();
      throw new Error(`HTTP ${res.status} – ${t.slice(0,120)}`);
    }

    const data = await res.json(); // { resultCount, results: [...] }
    const results = Array.isArray(data.results) ? data.results : [];
    // 过滤出有预览的
    const playable = results.filter(r => r.previewUrl);
    if (!playable.length){
      return fetchRandomTrackWithRetry(attempt+1);
    }

    const item = playable[Math.floor(Math.random()*playable.length)];
    renderTrack(item, term);

  } catch(err){
    mainContent.textContent = '加载失败： ' + err.message;
  }
}

function renderTrack(track, keyword){
  const title  = track.trackName || 'Untitled';
  const artist = track.artistName || 'Unknown';
  const album  = track.collectionName || '';
  const ms     = track.trackTimeMillis || 0;
  const secs   = ms ? Math.round(ms/1000) : null;
  const art100 = track.artworkUrl100 || '';
  // 试着把 100x100 换更清晰封面（Apple 常见规则）
  const art600 = art100 ? art100.replace('100x100bb', '600x600bb') : '';
  const preview= track.previewUrl || '';
  const source = track.trackViewUrl || track.collectionViewUrl || '';
  const artistUrl = track.artistViewUrl || '';

  const html = `
    <section class="card">
      <div>
        ${art600 ? `<img class="cover" src="${art600}" alt="Cover of ${escapeHtml(title)}"/>` : ''}
        ${preview ? `<audio controls src="${preview}" type="audio/m4a"></audio>` : ''}
      </div>
      <div>
        <h2 style="margin:.2rem 0 0">${escapeHtml(title)}</h2>
        <p style="margin:.2rem 0"><strong>Artist:</strong> ${escapeHtml(artist)}</p>
        ${album ? `<p style="margin:.2rem 0"><strong>Album:</strong> ${escapeHtml(album)}</p>` : ''}
        ${secs ? `<p style="margin:.2rem 0"><strong>Duration:</strong> ${secs}s</p>` : ''}
        <p style="margin:.6rem 0 0">
          ${source ? `<a href="${source}" target="_blank" rel="noreferrer">iTunes/Apple Music page</a>` : ''}
          ${artistUrl ? ` · <a href="${artistUrl}" target="_blank" rel="noreferrer">Artist</a>` : ''}
        </p>
        <p class="muted" style="margin-top:.6rem">Keyword: <code>${escapeHtml(keyword)}</code></p>
      </div>
    </section>
  `;
  mainContent.innerHTML = html;

  // 尝试自动播放（若被策略拦截，用户点播放）
  mainContent.querySelector('audio')?.play?.().catch(()=>{});
}

// 简单转义，避免把文本当 HTML 注入
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => (
    ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])
  ));
}
</script>
</body>
</html>
